@page
@model ImobSystem.Pages.ClientServicesModel
@{
    ViewData["Title"] = "Atendimentos";
}

<div class="text-center">
    <h1 class="display-4">Atendimentos</h1>
</div>

<div class="container">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Nome</th>
                        <th>Telefone</th>
                        <th>Interesse</th>
                        <th>Descrição do Imóvel</th>
                        <th>Valor do Imóvel</th>
                        <th>Origem do Cliente</th>
                        <th><a href="#" id="openNovoAtendimentoModal" data-bs-toggle="modal" data-bs-target="#novoAtendimentoModal" style="text-decoration: none; color: inherit;">Novo Atendimento</a></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.ClientServices != null)
                    {
                        foreach (var service in Model.ClientServices)
                        {
                            if (service.Client.ClientFases.Any(cf => cf.FaseId == 1))
                            {
                                <tr>
                                    <td>@service.Data.ToString("dd/MM/yyyy")</td>
                                    <td>@service.Client.Nome</td>
                                    <td>@service.Client.Telefone</td>
                                    <td>@service.Client.Interesse</td>
                                    <td>@service.Client.DescricaoImovel</td>
                                    <td>@service.Client.ValorImovel.ToString("C2")</td>
                                    <td>@service.Client.Origin</td>
                                    <td>
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#visitaModal-@service.Client.Id">VISITAR</button>
                                        <form method="post" asp-page-handler="Delete" asp-route-id="@service.Client.Id">
                                            <button type="submit" class="btn btn-danger" onclick="return confirm ('Tem certeza que deseja encerar esse atendimento ?')">EXCLUIR</button>
                                        </form> 
                                    </td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- Modal de novo atendimento -->
<div class="modal fade" id="novoAtendimentoModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Novo Atendimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeNovoAtendimentoModal"></button>
            </div>
            <div class="modal-body">
                <form method="post">
                    <div class="mb-3">
                        <label for="data" class="form-label">Data:</label>
                        <input type="date" class="form-control" id="data" name="Data" required> 
                    </div>
                    <div class="mb-3">
                        <label for="nome" class="form-label">Nome:</label>
                        <input type="text" class="form-control" id="nome" name="Client.Nome" required>
                    </div>
                    <div class="mb-3">
                        <label for="telefone" class="form-label">Telefone:</label>
                        <input type="text" class="form-control" id="telefone" name="Client.Telefone" required>
                    </div>
                    <div class="mb-3">
                        <label for="interesse" class="form-label">Interesse:</label>
                        <input type="text" class="form-control" id="interesse" name="Client.Interesse" required>
                    </div>
                    <div class="mb-3">
                        <label for="descricaoImovel" class="form-label">Descrição do Imóvel:</label>
                        <input type="text" class="form-control" id="descricaoImovel" name="Client.DescricaoImovel" required>
                    </div>
                    <div class="mb-3">
                        <label for="valorImovel" class="form-label">Valor do Imóvel:</label>
                        <input type="text" class="form-control" id="valorImovel" name="Client.ValorImovel" required oninput="formatCurrency(this)">
                    </div>
                    <div class="mb-3">
                        <label for="Origin" class="form-label">Origem:</label>
                        <input type="text" class="form-control" id="Irigin" name="Client.Origin" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div> 
<!-- Modais para visitas -->

@foreach (var service in Model.ClientServices)
{
    <div class="modal fade" id="visitaModal-@service.Client.Id" tabindex="-1" aria-labelledby="visitaModalLabel-@service.Client.Id" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="visitaModalLabel-@service.Client.Id">Adicionar Nova Visita</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" asp-page-handler="NovaVisita">
                        <input type="hidden" name="ClientId" value="@service.Client.Id" />
                       <!-- <div id="visitFormContainer-@service.Client.Id"> -->
                           <!-- <div class="visit-form"> -->
                                <div class="mb-3">
                                    <label for="dataVisita-@service.Client.Id" class="form-label">Data da Visita:</label>
                                    <input type="date" class="form-control" id="dataVisita-@service.Client.Id" name="VisitHouses[0].Data" required>
                                </div>
                                <div class="mb-3">
                                    <label for="houseId-@service.Client.Id" class="form-label">Imóvel:</label>
                                    <select class="form-select" id="houseId-@service.Client.Id" name="VisitHouses[0].HouseId" required>
                                        <option value="">Selecione um imóvel</option>
                                        @foreach (var house in Model.Houses)
                                        {
                                            <option value="@house.Id">@house.FullAddress</option>
                                        }
                                    </select>
                                </div>
                            <!-- </div> -->
                        <!--</div> -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            <button type="submit" class="btn btn-primary">Salvar Visita</button>
                            <!-- <button type="button" class="btn btn-success" onclick="addVisitForm(@service.Client.Id)">Adicionar Outra Visita</button> -->
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
}
<!-- 
<script>
    function addVisitForm(clientId) {
        const container = document.getElementById('visitFormContainer-' + clientId);
        const index = container.children.length;
        const newForm = document.createElement('div');
        newForm.className = 'visit-form';
        newForm.innerHTML = `
            <div class="mb-3">
                <label for="dataVisita-${clientId}-${index}" class="form-label">Data da Visita:</label>
                <input type="date" class="form-control" id="dataVisita-${clientId}-${index}" name="VisitHouses[${index}].Data" required>
            </div>
            <div class="mb-3">
                <label for="houseId-${clientId}-${index}" class="form-label">Imóvel:</label>
                <select class="form-select" id="houseId-${clientId}-${index}" name="VisitHouses[${index}].HouseId" required>
                    <option value="">Selecione um imóvel</option>
                    @foreach (var house in Model.Houses)
                    {
                        <option value="@house.Id">@house.FullAddress</option>
                    }
                </select>
            </div>
        `;
        container.appendChild(newForm);
    }
</script> -->